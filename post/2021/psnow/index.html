<!doctype html><html lang=fa dir=rtl><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>آسیب پذیری Remote Code Execution در PlayStation Now | امنیت و غیره به فارسی</title><meta name=keywords content><meta name=description content="این اولین بانتیِ PlayStation من و اولین متن فارسیِ من درباره امنیت است. متون فارسی در سایت خودم به دلیل راست به چپ بودن درست نمایش داده نمی‌شدند، این شد که یک تِمِ Hugo را دستکاری کردم.
نوشتن در مورد امنیت برای من به زبان فارسی سختِ. خودم را &ldquo;خارجی&rdquo; حساب نمی‌کنم ولی امنیت و اصطلاحاتش را به زبان انگلیسی یاد گرفته ام و زبانِ کار روزمره‌ام هست. در مقابل مثلاً در زمینه &ldquo;کلیله و دمنه&rdquo; به انگلیسی نمی‌توانم صحبت کنم."><meta name=author content="پارسیا"><link rel=canonical href=https://parsiya.github.io/parsiya.fa/post/2021/psnow/><link href=/parsiya.fa/assets/css/stylesheet.min.d08f6c302eba3eaecd589684c093cecdfe7dfb8745a207401bd0583d3bb31837.css integrity="sha256-0I9sMC66Pq7NWJaEwJPOzf59+4dFogdAG9BYPTuzGDc=" rel="preload stylesheet" as=style><link rel=icon href=https://parsiya.github.io/parsiya.fa/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://parsiya.github.io/parsiya.fa/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://parsiya.github.io/parsiya.fa/favicon-32x32.png><link rel=apple-touch-icon href=https://parsiya.github.io/parsiya.fa/apple-touch-icon.png><link rel=mask-icon href=https://parsiya.github.io/parsiya.fa/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><meta name=generator content="Hugo 0.101.0"><link rel=stylesheet href=https://parsiya.github.io/parsiya.fa/css/vazir-font.css><link rel=stylesheet href=https://parsiya.github.io/parsiya.fa/css/custom.css><meta property="og:title" content="آسیب پذیری Remote Code Execution در PlayStation Now"><meta property="og:description" content="این اولین بانتیِ PlayStation من و اولین متن فارسیِ من درباره امنیت است. متون فارسی در سایت خودم به دلیل راست به چپ بودن درست نمایش داده نمی‌شدند، این شد که یک تِمِ Hugo را دستکاری کردم.
نوشتن در مورد امنیت برای من به زبان فارسی سختِ. خودم را &ldquo;خارجی&rdquo; حساب نمی‌کنم ولی امنیت و اصطلاحاتش را به زبان انگلیسی یاد گرفته ام و زبانِ کار روزمره‌ام هست. در مقابل مثلاً در زمینه &ldquo;کلیله و دمنه&rdquo; به انگلیسی نمی‌توانم صحبت کنم."><meta property="og:type" content="article"><meta property="og:url" content="https://parsiya.github.io/parsiya.fa/post/2021/psnow/"><meta property="og:image" content="https://parsiya.github.io/parsiya.fa/post/2021/psnow/01-h1-bug.png"><meta property="article:section" content="post"><meta property="article:published_time" content="2021-03-29T19:20:09-08:00"><meta property="article:modified_time" content="2021-03-29T19:20:09-08:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://parsiya.github.io/parsiya.fa/post/2021/psnow/01-h1-bug.png"><meta name=twitter:title content="آسیب پذیری Remote Code Execution در PlayStation Now"><meta name=twitter:description content="این اولین بانتیِ PlayStation من و اولین متن فارسیِ من درباره امنیت است. متون فارسی در سایت خودم به دلیل راست به چپ بودن درست نمایش داده نمی‌شدند، این شد که یک تِمِ Hugo را دستکاری کردم.
نوشتن در مورد امنیت برای من به زبان فارسی سختِ. خودم را &ldquo;خارجی&rdquo; حساب نمی‌کنم ولی امنیت و اصطلاحاتش را به زبان انگلیسی یاد گرفته ام و زبانِ کار روزمره‌ام هست. در مقابل مثلاً در زمینه &ldquo;کلیله و دمنه&rdquo; به انگلیسی نمی‌توانم صحبت کنم."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://parsiya.github.io/parsiya.fa/post/"},{"@type":"ListItem","position":2,"name":"آسیب پذیری Remote Code Execution در PlayStation Now","item":"https://parsiya.github.io/parsiya.fa/post/2021/psnow/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"آسیب پذیری Remote Code Execution در PlayStation Now","name":"آسیب پذیری Remote Code Execution در PlayStation Now","description":"این اولین بانتیِ PlayStation من و اولین متن فارسیِ من درباره امنیت است. متون فارسی در سایت خودم به دلیل راست به چپ بودن درست نمایش داده نمی‌شدند، این شد که یک تِمِ Hugo را دستکاری کردم.\nنوشتن در مورد امنیت برای من به زبان فارسی سختِ. خودم را \u0026ldquo;خارجی\u0026rdquo; حساب نمی‌کنم ولی امنیت و اصطلاحاتش را به زبان انگلیسی یاد گرفته ام و زبانِ کار روزمره‌ام هست. در مقابل مثلاً در زمینه \u0026ldquo;کلیله و دمنه\u0026rdquo; به انگلیسی نمی‌توانم صحبت کنم.","keywords":[],"articleBody":"این اولین بانتیِ PlayStation من و اولین متن فارسیِ من درباره امنیت است. متون فارسی در سایت خودم به دلیل راست به چپ بودن درست نمایش داده نمی‌شدند، این شد که یک تِمِ Hugo را دستکاری کردم.\nنوشتن در مورد امنیت برای من به زبان فارسی سختِ. خودم را “خارجی” حساب نمی‌کنم ولی امنیت و اصطلاحاتش را به زبان انگلیسی یاد گرفته ام و زبانِ کار روزمره‌ام هست. در مقابل مثلاً در زمینه “کلیله و دمنه” به انگلیسی نمی‌توانم صحبت کنم.\nاگر مشکل زبان انگلیسی ندارید (خواندن گزارش زبان سطح بالایی لازم ندارد)، پیشنهاد من خواندن متن اصلی باگ در سایت هکروان است:\nhttps://hackerone.com/reports/873614 مقدمات این گزارش ترکیبی از سه باگ منطقی مختلف است. هر کدام از این باگها در یک محدوده تحقیقاتی مختلف قرار دارند. برای یادگرفتن این باگ ها شاید لازم باشد که موارد زیر را بدانید. در خیلی از موارد توضیحات مفصلی ندادم چون نمی‌شود همه چیز را در گزارش توضیح داد.\nنزدیک یک سال قبل من ارائه ای در مورد این باگ ها (این باگ هنوز disclose نشده بود) در Appsec village کنفرانس DEF CON 2020 داشتم. در آن یکی از باگ های مشابه خودم برای برنامه Attack Surface Analyzer مایکروسافت را بررسی کردم. ویدئو و اسلاید این ارائه در لینک زیر هستند: https://parsiya.net/blog/2020-08-13-localghost-escaping-the-browser-sandbox-without-0-days/ اطلاعات مربوط به هک برنامه های فریمورک الکترون https://github.com/doyensec/awesome-electronjs-hacking پیدا کردن سرورهای localhost و ترافیک برنامه های ویندوز https://parsiya.net/blog/2015-08-01-network-traffic-attribution-on-windows باگ های Tavis Ormandy از Google Project Zero درباره سرورهای localhost https://bugs.chromium.org/p/project-zero/issues/list?q=owner%3Ataviso%40google.com%20localhost\u0026can=1 خلاصه برنامه PlayStation Now نگارش 11.0.2 دارای آسیب پذیری “اجرای کد از راه دور” یا Remote Code Execution (RCE) است. هر وب سایتی که در کامپیوتری که برنامه را اجرا می‌کند باز شود می‌تواند از طریق یک websocket روی آن ماشین کد اجرا کند.\nسرور websocket که روی پورت 1235 اجرا می‌شود هدر origin ریکوئست ها را چک نمی‌کند. این به وب سایتهایی که روی ماشین باز شده‌اند اجازه می‌دهد که مستقیم به این سرور متصل شوند و داده بفرستند. websocket ها توسط Same-Origin Policy کنترل نمی‌شوند. یک وب سایت باز شده در مرورگر می‌تواند یک ارتباط websocket با هر سرور در دسترس ایجاد کند. برنامه psnow یک برنامه Electron به نام AGL را اجرا می‌کند. با فرستادن داده به سرور websocket، می‌توان به AGL دستور داد تا هر URL را بارگزاری کند. در نتیجه، هر وب سایت باز شده در ماشین می‌تواند به AGL دستور دهد تا هر URL که می‌خواهد را باز کند. همچنین می‌توان توسط دستور setUrlDefaultBrowser به AGL دستور داد که یک executable را اجرا کند (مثلاً calc). در برنامه AGL فیلد nodeIntegration فعال است. یعنی کد جاواسکریپت وب سایت باز شده در AGL میتواند از کتابخانه‌های Node استفاده کند. با سر هم کردن این سه باگ می‌توانیم به RCE برسیم.\nاصل ماجرا برنامه PlayStation Now یک برنامه برای استریم بازیهای پلی استیشن روی ویندوز است (البته این برنامه روی کنسول PS4 هم وجود دارد اما اینجا در مورد آن صحبت نمی‌کنیم). این برنامه دو بخش اصلی دارد. QAS و AGL.\nبرنامه QAS این برنامه اصلی بر پایه فریمورک Qt 5 (کیوت یا cute تلفظ می‌شود). اسم اصلی این برنامه psnowlauncher.exe است. بعد از اجرا دو کار انجام می‌دهد:\nبرنامه دیگری به نام AGL.exe را اجرا می‌کند. یک سرور websocket در آدرس localhost:1235 می‌سازد. برنامه AGL برنامه AGL بر پایه فریمورک Electron است. این برنامه توسط QAS و به صورت زیر با یک سوییچ url اجرا می‌شود.\n\"C:\\Program Files (x86)\\PlayStationNow\\agl\\agl.exe\" --url=https://psnow.playstation.com/app/1.10.43/105/00d3603f8/ بعد از اجرای برنامه، وب سایتی که با سوییچ url مشخص شده در برنامه باز می‌شود.\nفریمورک Electron هم Qt و هم Electron از فریمورک های پرطرفدار ساخت برنامه های دسکتاپ هستند. فریمورک الکترون بر پایه مرورگر متن باز Chromium ساخته شده است. مرورگرهای مشهوری مانند Chrome, Edge و Brave هم از آن استفاده می‌کنند. به خلاصه، هر صفحه یک برنامه الکترون یک تب مرورگر است که در آن یک صفحه وب نمایش داده می‌شود.\nیکی از اصلی ترین نکات هنگام بررسی یک برنامه الکترون بررسی فیلد nodeIntegration است. در صورت فعال بودن (به صورت پیش فرض غیرفعال است) کد جاوااسکریپت داخل مرورگر می‌تواند از کتابخانه‌های Node استفاده کند. من از دو روش برای چک کردن این فیلد استفاده می‌کنم:\nبازکردن کد برنامه و static analysis: کد جاوااسکریپت برنامه Electron معمولاً در یک فایل به نام app.asar است که می‌توان آن را به راحتی باز و مشاهده کرد. بعد از باز کردن کد برنامه سرچ کنید nodeIntegration و ببینید که آیا به مقدار true سِت شده است یا خیر. بازکردن یک وب سایت در برنامه که مثلاً ماشین حساب را اجرا می‌کند. برای اطلاعات بیشتر به این رفرنس که در قسمت مقدمات معرفی کردم مراجعه کنید.\nمشکل اول: nodeIntegration برای تست این فیلد من از روش دوم استفاده کردم. یک صفحه با کد زیر را در یک s3 bucket (سطل؟) ذخیره کردم. این کد ماشین حساب ویندوز را از طریق ماژول child_process اجرا می‌کند.\n\u003chtml\u003e \u003chead\u003e \u003ctitle\u003eThis should pop calc on Windows\u003c/title\u003e \u003c/head\u003e \u003cbody\u003e \u003cscript\u003e require('child_process') .exec('calc') \u003c/script\u003e \u003c/body\u003e \u003c/html\u003e سپس برنامه را دستی با سویچ url اجرا کردم.\n\"C:\\Program Files (x86)\\PlayStationNow\\agl\\agl.exe\" --url=https://[redacted].s3.us-east-1.amazonaws.com/node.html ماشین حساب ویندوز اجرا شد و معلوم که مقدار آن فیلد سِت شده است.\nتا اینجا کار خارق العاده ای انجام ندادم، روی کامپیوتر خودم دستی کد اجرا کرده‌ام. به قول این بلاگ، هنوز در سمت دیگر “دریچه” (یعنی روی کامپیوتر خودم) هستم.\nhttps://devblogs.microsoft.com/oldnewthing/20060508-22/?p=31283 مشکل دوم: سرور websocket همانطور که بالا دیدیم برنامه AGL روی پورت 1235 یک سرور websocket می‌سازد. قدم بعدی پراکسی کردن برنامه توسط Burp بود. برنامه های بر پایه مرورگر Chromium معمولاً از تنظیمات پراکسی ویندوز استفاده می‌کنند.\nپراکسی کردن ترافیک برنامه های دسکتاپ پراکسی کردن ترافیک این برنامه ساده بود ولی همیشه اینگونه نیست. این بحث مفصلی است و من تا امروز 18 بلاگ درباره آن نوشته‌ام و هنوز جا برای تحقیق زیاد دارد\nhttps://parsiya.net/categories/thick-client-proxying بعد از پراکسی کردن این برنامه ها ترافیک زیادی در Burp دیدم. یکی از مشکلات پراکسی کردن با تنظیمات ویندوز این است که بسیاری از برنامه های دیگر و سرویس های ویندوز نیز ترافیک خود را به پراکسی می‌فرستند. برای این کار می‌توانید دامنه‌های بی‌ربط را به TLS Passthrough اضافه کنید تا Burp آنها را پراکسی نکند. برای اطلاعات بیشتر بلاگ زیر را بخوانید:\nhttps://parsiya.net/blog/2020-05-01-towards-a-quieter-burp-history ترافیک برنامه‌ها را توسط user-Agent شان تشخیص دادم. هر دو برنامه کلمه gkApollo را در user-agent داشتند. پس بقیه ترافیک به درد من نمیخورد. برای تشخیص ترافیک این دو برنامه از هم به کلمات دیگر در user-agent دقت کردم:\nترافیک برنامه QAS که بر پایه Qt است این کلمه را دارد QtWebEngine/5.5.1. ترافیک برنامه AGL که بر پایه الکترون است این دو را دارد Electron/1.4.16 و playstation-now/0.0.0. توسط یک افزونه به نام Request Highlighter در Burp ترافیک این دو برنامه را زرد و آبی کردم که تشخیص آنها از هم راحت‌تر باشد.\nپروتکل پیام های websocket پس از پراکسی کردن در Burp ترافیک سرور websocket را می‌بینیم. پیام‌های پروتکل این سرور بسیار ساده بودند و به نظر می‌رسید توسط JSON.stringify ‌جاوااسکریپت ایجاد شده‌اند. .پیام ها به این شکل بودند:\n{ \"command\": \"isMicConnected\", \"params\": {}, \"source\": \"AGL\", \"target\": \"QAS\" } فرمان یا command که مشخص می‌کند این دستور باید چه کاری انجام دهد. پارامترهای دستور. بخشهای سوم و چهارم مبدا و مقصد پیام هستند. در واقع مبدا پیام مهم نیست و فقط مقصد مهم است. برای دیدن اینکه چه دستورهایی در برنامه وجود دارند دو کار کردم:\nبرنامه را اجرا کردم و چند کار داخل برنامه انجام دادم سپس ترافیک داخل Burp را دیدم. کد برنامه الکترون را باز کردم و اسم چند دستور که در Burp دیده بودم را سرچ کردم تا به بخش commandHandler رسیدم. در این بخش همه دستورات سرور وجود داشتند. دو دستور مهم هستند: setUrl و setUrlDefaultBrowser.\nsetUrl به برنامه می‌گوید که کدام وب سایت را باز کند. پیام این دستور به این شکل است:\n{ \"command\": \"setUrl\", \"params\": { \"url\": \"https://psnow.playstation.com/app/1.10.43/105/00d3603f8/\" }, \"source\": \"AGL\", \"target\": \"QAS\" } setUrlDefaultBrowser یک فایل را به کمک سیستم عامل باز می‌کند. مثلاَ اگر ورودی آن یک آدرس وب سایت باشد، آن را در مرورگر باز می‌کند و یک فایل ورد در برنامه آفیس (اگر نصب شده باشد) باز می‌شود. چند روز بعد از گزارش باگ به من به یاد یکی از باگ های Tavis Ormandy افتادم که با استفاده از این دستور به RCE دست یافته بود.\nhttps://bugs.chromium.org/p/project-zero/issues/detail?id=693 اگر یک فایل اجرایی را با این دستور باز کنیم، ویندوز خود آن فایل را اجرا می‌کند. پس دستور زیر ماشین حساب ویندوز را اجرا می‌کند.\n{ \"command\": \"setUrl\", \"params\": { \"url\": \"file:///c:/windows/system32/calc.exe\" }, \"source\": \"AGL\", \"target\": \"QAS\" } با استفاده از این دستور دیگر نیاز به nodeIntegration هم نداریم. اما این دستور یک محدودیت بزرگ دارد. فقط می‌توانیم فایل اجرا کنیم و نمی‌توانیم به فایل اجرایی پارامتر و یا سوییچ بفرستیم.\nمشکل سوم: اجرای کد روی ماشین توسط دستورات websocket در Burp دیدم که برنامه AGL (الکترون) به QAS می‌گوید که یک وب سایت را باز کند. در ابتدا من به مبدا و مقصد دقت نکردم و بی‌خیال باگ شدم چون بازکردن سایت در QAS فایده‌ای برای من نداشت. اما چند ساعت بعد وقتی کار دیگری انجام می‌دادم یادم آمد که چرا مقصد را AGL (برنامه الکترون) نگذارم؟ با فرستادن پیام پایین وب سایتی که در بخش اول ساخته بودم (ماشین حساب ویندوز را اجرا می‌کرد) در برنامه الکترون باز کردم و ماشین حساب ویندوز اجرا شد.\n{ \"command\": \"setUrl\", \"params\": { \"url\": \"https://example.net\" }, \"source\": \"AGL\", \"target\": \"QAS\" } بعد از این کد یک برنامه چت بر پایه websocket را دستکاری کردم و در سطل (؟) s3 دیگری قرار دادم. بعد از باز کردن این وب سایت در مرورگر روی کامپیوتری که برنامه psnow در حال اجرا بود می‌توانستم با سرور websocket صحبت کنم و به آن دستور بفرستم.\nامنیت websocket اولین مرحله در ایجاد ارتباط با یک سرور websocket، فرستادن یک ریکوئست HTTP با تعدادی هِدِر (header) خاص است. در حالت عادی Same-Origin Policy یا SOP مرورگر به اسکریپت‌های یک اریجین اجازه نمی‌دهد تا با اریجین دیگر ارتباط برقرار کنند (بحث SOP مفصلتر از این است که اینجا مطرح کنم ولی حتماً در مورد آن بخوانید چون یکی از مهمترین بخشهای امنیت مرورگر و وب است). websocket ها شامل SOP نمیشوند. یعنی هر وب سایت میتواند با هر سرور websocket ارتباط برقرار کند.\nحل این مشکلات تا اینجا سه باگ را بررسی کردیم و فهمیدیم که اگر برنامه PlayStation Now را اجرا کنیم. وب سایتی که در مرورگر کامپیوتر ما باز شده است می‌تواند روی ماشین ما کد اجرا کند. این اصلاً خوب نیست.\nیکی از مهمترین وظایف من به عنوان یک مهندس امنیت نرم افزار، حل مشکلات امنیتی است. راحت‌ترین روش حل این مشکل چک کردن هدر origin در اولین قدم ایجاد ارتباط websocket است. این هدر فقط توسط مرورگر می‌تواند اضافه شود1. اولین ریکوئست ایجاد یک websocket شکلی مشابه این دارد:\nGET /chat HTTP/1.1 Host: example.com:8000 Upgrade: websocket Connection: Upgrade Sec-WebSocket-Key: dGhlIHNhbXBsZSBub25jZQ== - مقدار این هدر معمولاً مهم نیست Sec-WebSocket-Version: 13 Origin: whatever.com چون نمی‌توان به مکانیزم SOP برای فیلتر کردن درخواست های websocket اتکا کرد باید به صورت دستی هدر origin را بررسی کنیم و مواردی که نمی‌خواهیم (مثلاً هر چه که از playstation.com.* نیست) را رد کنیم.\nدومین مشکل این است که سرور روی همه IP های دستگاه در حال شنیدن است. به عبارت دیگر روی 0.0.0.0 بایند شده. این یعنی هر کسی که بتواند به پورت 1235 دستگاه از خارج دسترسی داشته باشد می‌تواند به آن وصل شود. در دنیای واقعی این مشکل آنقدر ترسناک نیست زیرا اکثر مودم و روترها تنها اجازه دسترسی مستقیم به پورت را در شبکه داخلی می‌دهند. برای حل این مشکل باید سرور روی localhost بایند شود.\nچی یاد گرفتیم؟ متاسفانه در این باگ مرزهای علم را جابجا نکردم و دانش جدیدی تولید نشد. خودم هم چیز جدیدی یاد نگرفتم. اما امیدوارم خواننده چند نکته یادگرفته باشد. اگر بازخورد یا پیشنهادی دارید، پیدا کردن من در اینترنت بسیار راحت است.\nبه این هدرها forbidden header می‌گویند. ↩︎\n","wordCount":"1930","inLanguage":"fa","image":"https://parsiya.github.io/parsiya.fa/post/2021/psnow/01-h1-bug.png","datePublished":"2021-03-29T19:20:09-08:00","dateModified":"2021-03-29T19:20:09-08:00","author":{"@type":"Person","name":"پارسیا"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://parsiya.github.io/parsiya.fa/post/2021/psnow/"},"publisher":{"@type":"Organization","name":"امنیت و غیره به فارسی","logo":{"@type":"ImageObject","url":"https://parsiya.github.io/parsiya.fa/favicon.ico"}}}</script></head><body class=dark id=top><script>localStorage.getItem("pref-theme")==="light"&&document.body.classList.remove("dark")</script><noscript><style type=text/css>#theme-toggle,.top-link{display:none}</style></noscript><header class=header><nav class=nav><div class=logo><a href=https://parsiya.github.io/parsiya.fa/ accesskey=h title="امنیت و غیره به فارسی (Alt + H)">امنیت و غیره به فارسی</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></div><ul id=menu onscroll=menu_on_scroll()></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://parsiya.github.io/parsiya.fa/>Home</a>&nbsp;»&nbsp;<a href=https://parsiya.github.io/parsiya.fa/post/>Posts</a></div><h1 class=post-title>آسیب پذیری Remote Code Execution در PlayStation Now</h1><div class=post-meta>March 29, 2021&nbsp;·&nbsp;پارسیا</div></header><figure class=entry-cover><img loading=lazy srcset="https://parsiya.github.io/parsiya.fa/post/2021/psnow/01-h1-bug_hu231bee9bf2688ac7191aa5521de0f23b_37669_360x0_resize_box_3.png 360w ,https://parsiya.github.io/parsiya.fa/post/2021/psnow/01-h1-bug_hu231bee9bf2688ac7191aa5521de0f23b_37669_480x0_resize_box_3.png 480w ,https://parsiya.github.io/parsiya.fa/post/2021/psnow/01-h1-bug_hu231bee9bf2688ac7191aa5521de0f23b_37669_720x0_resize_box_3.png 720w ,https://parsiya.github.io/parsiya.fa/post/2021/psnow/01-h1-bug.png 1019w" sizes="(min-width: 768px) 720px, 100vw" src=https://parsiya.github.io/parsiya.fa/post/2021/psnow/01-h1-bug.png alt></figure><div class=toc><details><summary accesskey=c title="(Alt + C)"><div class=details>فهرست مطالب</div></summary><div class=inner><ul><li><a href=#%d9%85%d9%82%d8%af%d9%85%d8%a7%d8%aa aria-label=مقدمات>مقدمات</a></li><li><a href=#%d8%ae%d9%84%d8%a7%d8%b5%d9%87 aria-label=خلاصه>خلاصه</a></li><li><a href=#%d8%a7%d8%b5%d9%84-%d9%85%d8%a7%d8%ac%d8%b1%d8%a7 aria-label="اصل ماجرا">اصل ماجرا</a><ul><li><a href=#%d8%a8%d8%b1%d9%86%d8%a7%d9%85%d9%87-qas aria-label="برنامه QAS">برنامه QAS</a></li><li><a href=#%d8%a8%d8%b1%d9%86%d8%a7%d9%85%d9%87-agl aria-label="برنامه AGL">برنامه AGL</a></li></ul></li><li><a href=#%d9%81%d8%b1%db%8c%d9%85%d9%88%d8%b1%da%a9-electron aria-label="فریمورک Electron">فریمورک Electron</a><ul><li><a href=#%d9%85%d8%b4%da%a9%d9%84-%d8%a7%d9%88%d9%84-nodeintegration aria-label="مشکل اول: nodeIntegration">مشکل اول: nodeIntegration</a></li><li><a href=#%d9%85%d8%b4%da%a9%d9%84-%d8%af%d9%88%d9%85-%d8%b3%d8%b1%d9%88%d8%b1-websocket aria-label="مشکل دوم: سرور websocket">مشکل دوم: سرور websocket</a><ul><li><a href=#%d9%be%d8%b1%d8%a7%da%a9%d8%b3%db%8c-%da%a9%d8%b1%d8%af%d9%86-%d8%aa%d8%b1%d8%a7%d9%81%db%8c%da%a9-%d8%a8%d8%b1%d9%86%d8%a7%d9%85%d9%87-%d9%87%d8%a7%db%8c-%d8%af%d8%b3%da%a9%d8%aa%d8%a7%d9%be aria-label="پراکسی کردن ترافیک برنامه های دسکتاپ">پراکسی کردن ترافیک برنامه های دسکتاپ</a></li><li><a href=#%d9%be%d8%b1%d9%88%d8%aa%da%a9%d9%84-%d9%be%db%8c%d8%a7%d9%85-%d9%87%d8%a7%db%8c-websocket aria-label="پروتکل پیام های websocket">پروتکل پیام های websocket</a></li></ul></li><li><a href=#%d9%85%d8%b4%da%a9%d9%84-%d8%b3%d9%88%d9%85-%d8%a7%d8%ac%d8%b1%d8%a7%db%8c-%da%a9%d8%af-%d8%b1%d9%88%db%8c-%d9%85%d8%a7%d8%b4%db%8c%d9%86-%d8%aa%d9%88%d8%b3%d8%b7-%d8%af%d8%b3%d8%aa%d9%88%d8%b1%d8%a7%d8%aa-websocket aria-label="مشکل سوم: اجرای کد روی ماشین توسط دستورات websocket">مشکل سوم: اجرای کد روی ماشین توسط دستورات websocket</a><ul><li><a href=#%d8%a7%d9%85%d9%86%db%8c%d8%aa-websocket aria-label="امنیت websocket">امنیت websocket</a></li></ul></li></ul></li><li><a href=#%d8%ad%d9%84-%d8%a7%db%8c%d9%86-%d9%85%d8%b4%da%a9%d9%84%d8%a7%d8%aa aria-label="حل این مشکلات">حل این مشکلات</a></li><li><a href=#%da%86%db%8c-%db%8c%d8%a7%d8%af-%da%af%d8%b1%d9%81%d8%aa%db%8c%d9%85 aria-label="چی یاد گرفتیم؟">چی یاد گرفتیم؟</a></li></ul></div></details></div><div class=post-content><p>این اولین بانتیِ PlayStation من و اولین متن فارسیِ من درباره امنیت است. متون
فارسی در سایت خودم به دلیل راست به چپ بودن درست نمایش داده نمی‌شدند، این شد که
یک تِمِ <a href=https://gohugo.io>Hugo</a> را دستکاری کردم.</p><p>نوشتن در مورد امنیت برای من به زبان فارسی سختِ. خودم را &ldquo;خارجی&rdquo; حساب نمی‌کنم ولی
امنیت و اصطلاحاتش را به زبان انگلیسی یاد گرفته ام و زبانِ کار روزمره‌ام هست. در
مقابل مثلاً در زمینه &ldquo;کلیله و دمنه&rdquo; به انگلیسی نمی‌توانم صحبت کنم.</p><p>اگر مشکل زبان انگلیسی ندارید (خواندن گزارش زبان سطح بالایی لازم ندارد)، پیشنهاد
من خواندن متن اصلی باگ در سایت هکروان است:</p><ul><li><a href=https://hackerone.com/reports/873614 title="Websites Can Run Arbitrary Code on Machines Running the 'PlayStation Now' Application">https://hackerone.com/reports/873614</a></li></ul><h2 id=مقدمات>مقدمات<a hidden class=anchor aria-hidden=true href=#مقدمات>#</a></h2><p>این گزارش ترکیبی از سه باگ منطقی مختلف است. هر کدام از این باگها در یک محدوده
تحقیقاتی مختلف قرار دارند. برای یادگرفتن این باگ ها شاید لازم باشد که موارد زیر
را بدانید. در خیلی از موارد توضیحات مفصلی ندادم چون نمی‌شود همه چیز را در گزارش
توضیح داد.</p><ol><li>نزدیک یک سال قبل من ارائه ای در مورد این باگ ها (این باگ هنوز disclose نشده
بود) در Appsec village کنفرانس DEF CON 2020 داشتم. در آن یکی از باگ های مشابه
خودم برای برنامه Attack Surface Analyzer مایکروسافت را بررسی کردم. ویدئو و
اسلاید این ارائه در لینک زیر هستند:<ol><li><a href=https://parsiya.net/blog/2020-08-13-localghost-escaping-the-browser-sandbox-without-0-days/>https://parsiya.net/blog/2020-08-13-localghost-escaping-the-browser-sandbox-without-0-days/</a></li></ol></li><li>اطلاعات مربوط به هک برنامه های فریمورک الکترون<ol><li><a href=https://github.com/doyensec/awesome-electronjs-hacking>https://github.com/doyensec/awesome-electronjs-hacking</a></li></ol></li><li>پیدا کردن سرورهای localhost و ترافیک برنامه های ویندوز<ol><li><a href=https://parsiya.net/blog/2015-08-01-network-traffic-attribution-on-windows>https://parsiya.net/blog/2015-08-01-network-traffic-attribution-on-windows</a></li></ol></li><li>باگ های Tavis Ormandy از Google Project Zero درباره سرورهای localhost<ol><li><a href="https://bugs.chromium.org/p/project-zero/issues/list?q=owner%3Ataviso%40google.com%20localhost&can=1">https://bugs.chromium.org/p/project-zero/issues/list?q=owner%3Ataviso%40google.com%20localhost&can=1</a></li></ol></li></ol><h2 id=خلاصه>خلاصه<a hidden class=anchor aria-hidden=true href=#خلاصه>#</a></h2><p>برنامه PlayStation Now نگارش 11.0.2 دارای آسیب پذیری &ldquo;اجرای کد از راه دور&rdquo; یا
Remote Code Execution (RCE) است. هر وب سایتی که در کامپیوتری که برنامه را اجرا
می‌کند باز شود می‌تواند از طریق یک websocket روی آن ماشین کد اجرا کند.</p><ol><li>سرور websocket که روی پورت 1235 اجرا می‌شود هدر origin ریکوئست ها را چک
نمی‌کند. این به وب سایتهایی که روی ماشین باز شده‌اند اجازه می‌دهد که مستقیم
به این سرور متصل شوند و داده بفرستند.<ul><li>websocket ها توسط Same-Origin Policy کنترل نمی‌شوند. یک وب سایت باز شده
در مرورگر می‌تواند یک ارتباط websocket با هر سرور در دسترس ایجاد کند.</li></ul></li><li>برنامه psnow یک برنامه Electron به نام AGL را اجرا می‌کند. با فرستادن داده به
سرور websocket، می‌توان به AGL دستور داد تا هر URL را بارگزاری کند.<ul><li>در نتیجه، هر وب سایت باز شده در ماشین می‌تواند به AGL دستور دهد تا هر URL
که می‌خواهد را باز کند.</li><li>همچنین می‌توان توسط دستور <code>setUrlDefaultBrowser</code> به AGL دستور داد که یک
executable را اجرا کند (مثلاً calc).</li></ul></li><li>در برنامه AGL فیلد <code>nodeIntegration</code> فعال است. یعنی کد جاواسکریپت وب سایت باز
شده در AGL میتواند از کتابخانه‌های Node استفاده کند.</li></ol><p><strong>با سر هم کردن این سه باگ می‌توانیم به RCE برسیم.</strong></p><h2 id=اصل-ماجرا>اصل ماجرا<a hidden class=anchor aria-hidden=true href=#اصل-ماجرا>#</a></h2><p>برنامه PlayStation Now یک برنامه برای استریم بازیهای پلی استیشن روی ویندوز است
(البته این برنامه روی کنسول PS4 هم وجود دارد اما اینجا در مورد آن صحبت
نمی‌کنیم). این برنامه دو بخش اصلی دارد. QAS و AGL.</p><h3 id=برنامه-qas>برنامه QAS<a hidden class=anchor aria-hidden=true href=#برنامه-qas>#</a></h3><p>این برنامه اصلی بر پایه فریمورک <a href=https://www.qt.io/>Qt 5</a> (کیوت یا cute تلفظ
می‌شود). اسم اصلی این برنامه psnowlauncher.exe است. بعد از اجرا دو کار انجام
می‌دهد:</p><ol><li>برنامه دیگری به نام AGL.exe را اجرا می‌کند.</li><li>یک سرور websocket در آدرس <code>localhost:1235</code> می‌سازد.</li></ol><h3 id=برنامه-agl>برنامه AGL<a hidden class=anchor aria-hidden=true href=#برنامه-agl>#</a></h3><p>برنامه AGL بر پایه فریمورک <a href=https://electronjs.org>Electron</a> است. این برنامه
توسط QAS و به صورت زیر با یک سوییچ <code>url</code> اجرا می‌شود.</p><pre tabindex=0><code>&#34;C:\Program Files (x86)\PlayStationNow\agl\agl.exe&#34;
    --url=https://psnow.playstation.com/app/1.10.43/105/00d3603f8/
</code></pre><p>بعد از اجرای برنامه، وب سایتی که با سوییچ <code>url</code> مشخص شده در برنامه باز می‌شود.</p><h2 id=فریمورک-electron>فریمورک Electron<a hidden class=anchor aria-hidden=true href=#فریمورک-electron>#</a></h2><p>هم Qt و هم Electron از فریمورک های پرطرفدار ساخت برنامه های دسکتاپ هستند.
فریمورک الکترون بر پایه مرورگر متن باز Chromium ساخته شده است. مرورگرهای مشهوری
مانند Chrome, Edge و Brave هم از آن استفاده می‌کنند. به خلاصه، هر صفحه یک برنامه
الکترون یک تب مرورگر است که در آن یک صفحه وب نمایش داده می‌شود.</p><p>یکی از اصلی ترین نکات هنگام بررسی یک برنامه الکترون بررسی فیلد <code>nodeIntegration</code>
است. در صورت فعال بودن (به صورت پیش فرض غیرفعال است) کد جاوااسکریپت داخل مرورگر
می‌تواند از کتابخانه‌های Node استفاده کند. من از دو روش برای چک کردن این فیلد
استفاده می‌کنم:</p><ol><li>بازکردن کد برنامه و static analysis: کد جاوااسکریپت برنامه Electron معمولاً
در یک فایل به نام <code>app.asar</code> است که <a href=https://blog.doyensec.com/2018/07/19/instrumenting-electron-app.html title="Instrumenting Electron Apps for Security Testing - blog.doyensec.com">می‌توان آن را به راحتی باز و
مشاهده</a>
کرد. بعد از باز کردن کد برنامه سرچ کنید <code>nodeIntegration</code> و ببینید که آیا به
مقدار true سِت شده است یا خیر.</li><li>بازکردن یک وب سایت در برنامه که مثلاً ماشین حساب را اجرا می‌کند.</li></ol><p>برای اطلاعات بیشتر به <a href=https://github.com/doyensec/awesome-electronjs-hacking title="Awesome Electron.js hacking & pentesting resources - gitub.com">این رفرنس</a>
که در قسمت مقدمات معرفی کردم مراجعه کنید.</p><h3 id=مشکل-اول-nodeintegration>مشکل اول: nodeIntegration<a hidden class=anchor aria-hidden=true href=#مشکل-اول-nodeintegration>#</a></h3><p>برای تست این فیلد من از روش دوم استفاده کردم. یک صفحه با کد زیر را در یک s3
bucket (سطل؟) ذخیره کردم. این کد ماشین حساب ویندوز را از طریق ماژول <code>child_process</code>
اجرا می‌کند.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-html data-lang=html><span style=display:flex><span>&lt;<span style=color:#f92672>html</span>&gt;
</span></span><span style=display:flex><span>    &lt;<span style=color:#f92672>head</span>&gt;
</span></span><span style=display:flex><span>        &lt;<span style=color:#f92672>title</span>&gt;This should pop calc on Windows&lt;/<span style=color:#f92672>title</span>&gt;
</span></span><span style=display:flex><span>    &lt;/<span style=color:#f92672>head</span>&gt;
</span></span><span style=display:flex><span>    &lt;<span style=color:#f92672>body</span>&gt;
</span></span><span style=display:flex><span>        &lt;<span style=color:#f92672>script</span>&gt;
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#39;child_process&#39;</span>)
</span></span><span style=display:flex><span>            .<span style=color:#a6e22e>exec</span>(<span style=color:#e6db74>&#39;calc&#39;</span>)
</span></span><span style=display:flex><span>        &lt;/<span style=color:#f92672>script</span>&gt;
</span></span><span style=display:flex><span>    &lt;/<span style=color:#f92672>body</span>&gt;
</span></span><span style=display:flex><span>&lt;/<span style=color:#f92672>html</span>&gt;
</span></span></code></pre></div><p>سپس برنامه را دستی با سویچ <code>url</code> اجرا کردم.</p><pre tabindex=0><code>&#34;C:\Program Files (x86)\PlayStationNow\agl\agl.exe&#34;
    --url=https://[redacted].s3.us-east-1.amazonaws.com/node.html
</code></pre><p>ماشین حساب ویندوز اجرا شد و معلوم که مقدار آن فیلد سِت شده است.</p><p>تا اینجا کار خارق العاده ای انجام ندادم، روی کامپیوتر خودم دستی کد اجرا کرده‌ام.
به قول این بلاگ، هنوز در سمت دیگر &ldquo;دریچه&rdquo; (یعنی روی کامپیوتر خودم) هستم.</p><ul><li><a href="https://devblogs.microsoft.com/oldnewthing/20060508-22/?p=31283">https://devblogs.microsoft.com/oldnewthing/20060508-22/?p=31283</a></li></ul><h3 id=مشکل-دوم-سرور-websocket>مشکل دوم: سرور websocket<a hidden class=anchor aria-hidden=true href=#مشکل-دوم-سرور-websocket>#</a></h3><p>همانطور که بالا دیدیم برنامه AGL روی پورت 1235 یک سرور websocket می‌سازد. قدم
بعدی پراکسی کردن برنامه توسط Burp بود. برنامه های بر پایه مرورگر Chromium
معمولاً از <a href=https://parsiya.net/cheatsheet/#shortcut-to-ie-or-wininet-proxy-settings>تنظیمات پراکسی
ویندوز</a>
استفاده می‌کنند.</p><h4 id=پراکسی-کردن-ترافیک-برنامه-های-دسکتاپ>پراکسی کردن ترافیک برنامه های دسکتاپ<a hidden class=anchor aria-hidden=true href=#پراکسی-کردن-ترافیک-برنامه-های-دسکتاپ>#</a></h4><p>پراکسی کردن ترافیک این برنامه ساده بود ولی همیشه اینگونه نیست. این بحث مفصلی است
و من تا امروز 18 بلاگ درباره آن نوشته‌ام و هنوز جا برای تحقیق زیاد دارد</p><ul><li><a href=https://parsiya.net/categories/thick-client-proxying>https://parsiya.net/categories/thick-client-proxying</a></li></ul><p>بعد از پراکسی کردن این برنامه ها ترافیک زیادی در Burp دیدم. یکی از مشکلات پراکسی
کردن با تنظیمات ویندوز این است که بسیاری از برنامه های دیگر و سرویس های ویندوز
نیز ترافیک خود را به پراکسی می‌فرستند. برای این کار می‌توانید دامنه‌های بی‌ربط
را به TLS Passthrough اضافه کنید تا Burp آنها را پراکسی نکند. برای اطلاعات بیشتر
بلاگ زیر را بخوانید:</p><ul><li><a href=https://parsiya.net/blog/2020-05-01-towards-a-quieter-burp-history>https://parsiya.net/blog/2020-05-01-towards-a-quieter-burp-history</a></li></ul><p>ترافیک برنامه‌ها را توسط <code>user-Agent</code> شان تشخیص دادم. هر دو برنامه کلمه
<code>gkApollo</code> را در <code>user-agent</code> داشتند. پس بقیه ترافیک به درد من نمیخورد. برای
تشخیص ترافیک این دو برنامه از هم به کلمات دیگر در <code>user-agent</code> دقت کردم:</p><ul><li>ترافیک برنامه QAS که بر پایه Qt است این کلمه را دارد <code>QtWebEngine/5.5.1</code>.</li><li>ترافیک برنامه AGL که بر پایه الکترون است این دو را دارد <code>Electron/1.4.16</code> و <code>playstation-now/0.0.0</code>.</li></ul><p>توسط یک افزونه به نام <a href=https://portswigger.net/bappstore/11729a617d8d4d3b87c82e34b71885c3>Request Highlighter</a> در Burp ترافیک این
دو برنامه را زرد و آبی کردم که تشخیص آنها از هم راحت‌تر باشد.</p><h4 id=پروتکل-پیام-های-websocket>پروتکل پیام های websocket<a hidden class=anchor aria-hidden=true href=#پروتکل-پیام-های-websocket>#</a></h4><p>پس از پراکسی کردن در Burp ترافیک سرور websocket را می‌بینیم. پیام‌های پروتکل این
سرور بسیار ساده بودند و به نظر می‌رسید توسط <code>JSON.stringify</code> ‌جاوااسکریپت ایجاد شده‌اند.
.پیام ها به این شکل بودند:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;command&#34;</span>: <span style=color:#e6db74>&#34;isMicConnected&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;params&#34;</span>: {},
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;source&#34;</span>: <span style=color:#e6db74>&#34;AGL&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;target&#34;</span>: <span style=color:#e6db74>&#34;QAS&#34;</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ol><li>فرمان یا <code>command</code> که مشخص می‌کند این دستور باید چه کاری انجام دهد.</li><li>پارامترهای دستور.</li><li>بخشهای سوم و چهارم مبدا و مقصد پیام هستند. در واقع مبدا پیام مهم نیست و فقط
مقصد مهم است.</li></ol><p>برای دیدن اینکه چه دستورهایی در برنامه وجود دارند دو کار کردم:</p><ol><li>برنامه را اجرا کردم و چند کار داخل برنامه انجام دادم سپس ترافیک داخل Burp را
دیدم.</li><li>کد برنامه الکترون را باز کردم و اسم چند دستور که در Burp دیده بودم را سرچ
کردم تا به بخش commandHandler رسیدم. در این بخش همه دستورات سرور وجود داشتند.</li></ol><p>دو دستور مهم هستند: <code>setUrl</code> و <code>setUrlDefaultBrowser</code>.</p><p><code>setUrl</code> به برنامه می‌گوید که کدام وب سایت را باز کند. پیام این دستور به این شکل است:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;command&#34;</span>: <span style=color:#e6db74>&#34;setUrl&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;params&#34;</span>: {
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;url&#34;</span>: <span style=color:#e6db74>&#34;https://psnow.playstation.com/app/1.10.43/105/00d3603f8/&#34;</span>
</span></span><span style=display:flex><span>  },
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;source&#34;</span>: <span style=color:#e6db74>&#34;AGL&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;target&#34;</span>: <span style=color:#e6db74>&#34;QAS&#34;</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><code>setUrlDefaultBrowser</code> یک فایل را به کمک سیستم عامل باز می‌کند. مثلاَ اگر ورودی
آن یک آدرس وب سایت باشد، آن را در مرورگر باز می‌کند و یک فایل ورد در برنامه آفیس
(اگر نصب شده باشد) باز می‌شود. چند روز بعد از گزارش باگ به من به یاد یکی از باگ
های Tavis Ormandy افتادم که با استفاده از این دستور به RCE دست یافته بود.</p><ul><li><a href="https://bugs.chromium.org/p/project-zero/issues/detail?id=693">https://bugs.chromium.org/p/project-zero/issues/detail?id=693</a></li></ul><p>اگر یک فایل اجرایی را با این دستور باز کنیم، ویندوز خود آن فایل را اجرا می‌کند.
پس دستور زیر ماشین حساب ویندوز را اجرا می‌کند.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;command&#34;</span>: <span style=color:#e6db74>&#34;setUrl&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;params&#34;</span>: {
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;url&#34;</span>: <span style=color:#e6db74>&#34;file:///c:/windows/system32/calc.exe&#34;</span>
</span></span><span style=display:flex><span>  },
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;source&#34;</span>: <span style=color:#e6db74>&#34;AGL&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;target&#34;</span>: <span style=color:#e6db74>&#34;QAS&#34;</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>با استفاده از این دستور دیگر نیاز به <code>nodeIntegration</code> هم نداریم. اما این دستور
یک محدودیت بزرگ دارد. فقط می‌توانیم فایل اجرا کنیم و نمی‌توانیم به فایل اجرایی
پارامتر و یا سوییچ بفرستیم.</p><h3 id=مشکل-سوم-اجرای-کد-روی-ماشین-توسط-دستورات-websocket>مشکل سوم: اجرای کد روی ماشین توسط دستورات websocket<a hidden class=anchor aria-hidden=true href=#مشکل-سوم-اجرای-کد-روی-ماشین-توسط-دستورات-websocket>#</a></h3><p>در Burp دیدم که برنامه AGL (الکترون) به QAS می‌گوید که یک وب سایت را باز کند. در
ابتدا من به مبدا و مقصد دقت نکردم و بی‌خیال باگ شدم چون بازکردن سایت در QAS
فایده‌ای برای من نداشت. اما چند ساعت بعد وقتی کار دیگری انجام می‌دادم یادم آمد
که چرا مقصد را AGL (برنامه الکترون) نگذارم؟ با فرستادن پیام پایین وب سایتی که در
بخش اول ساخته بودم (ماشین حساب ویندوز را اجرا می‌کرد) در برنامه الکترون باز کردم
و ماشین حساب ویندوز اجرا شد.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;command&#34;</span>: <span style=color:#e6db74>&#34;setUrl&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;params&#34;</span>: {
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;url&#34;</span>: <span style=color:#e6db74>&#34;https://example.net&#34;</span>
</span></span><span style=display:flex><span>  },
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;source&#34;</span>: <span style=color:#e6db74>&#34;AGL&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;target&#34;</span>: <span style=color:#e6db74>&#34;QAS&#34;</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>بعد از این کد یک برنامه چت بر پایه websocket را دستکاری کردم و در سطل (؟) s3
دیگری قرار دادم. بعد از باز کردن این وب سایت در مرورگر روی کامپیوتری که برنامه
psnow در حال اجرا بود می‌توانستم با سرور websocket صحبت کنم و به آن دستور
بفرستم.</p><h4 id=امنیت-websocket>امنیت websocket<a hidden class=anchor aria-hidden=true href=#امنیت-websocket>#</a></h4><p>اولین مرحله در ایجاد ارتباط با یک سرور websocket، فرستادن یک ریکوئست HTTP با
تعدادی هِدِر (header) خاص است. در حالت عادی Same-Origin Policy یا SOP مرورگر به
اسکریپت‌های یک اریجین اجازه نمی‌دهد تا با اریجین دیگر ارتباط برقرار کنند (بحث
SOP مفصلتر از این است که اینجا مطرح کنم ولی حتماً در مورد آن بخوانید چون یکی از
مهمترین بخشهای امنیت مرورگر و وب است). <strong>websocket ها شامل SOP نمیشوند</strong>. یعنی
هر وب سایت میتواند با هر سرور websocket ارتباط برقرار کند.</p><p><img loading=lazy src=02-sop-mirrorsedge.jpg alt></p><h2 id=حل-این-مشکلات>حل این مشکلات<a hidden class=anchor aria-hidden=true href=#حل-این-مشکلات>#</a></h2><p>تا اینجا سه باگ را بررسی کردیم و فهمیدیم که اگر برنامه PlayStation Now را اجرا
کنیم. وب سایتی که در مرورگر کامپیوتر ما باز شده است می‌تواند روی ماشین ما کد
اجرا کند. این اصلاً خوب نیست.</p><p>یکی از مهمترین وظایف من به عنوان یک <a href=https://ea.com/security>مهندس امنیت نرم افزار</a>، حل
مشکلات امنیتی است. <strong>راحت‌ترین روش حل این مشکل چک کردن هدر origin در اولین قدم
ایجاد ارتباط websocket است.</strong> این هدر فقط توسط مرورگر می‌تواند اضافه شود<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup>.
اولین ریکوئست ایجاد یک websocket شکلی مشابه این دارد:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-http data-lang=http><span style=display:flex><span><span style=color:#a6e22e>GET</span> /chat <span style=color:#66d9ef>HTTP</span><span style=color:#f92672>/</span><span style=color:#ae81ff>1.1</span>
</span></span><span style=display:flex><span>Host<span style=color:#f92672>:</span> <span style=color:#ae81ff>example.com:8000</span>
</span></span><span style=display:flex><span>Upgrade<span style=color:#f92672>:</span> <span style=color:#ae81ff>websocket</span>
</span></span><span style=display:flex><span>Connection<span style=color:#f92672>:</span> <span style=color:#ae81ff>Upgrade</span>
</span></span><span style=display:flex><span>Sec-WebSocket-Key<span style=color:#f92672>:</span> <span style=color:#ae81ff>dGhlIHNhbXBsZSBub25jZQ== - مقدار این هدر معمولاً مهم نیست</span>
</span></span><span style=display:flex><span>Sec-WebSocket-Version<span style=color:#f92672>:</span> <span style=color:#ae81ff>13</span>
</span></span><span style=display:flex><span>Origin<span style=color:#f92672>:</span> <span style=color:#ae81ff>whatever.com</span>
</span></span></code></pre></div><p>چون نمی‌توان به مکانیزم SOP برای فیلتر کردن درخواست های websocket اتکا کرد باید
به صورت دستی هدر origin را بررسی کنیم و مواردی که نمی‌خواهیم (مثلاً هر چه که از
<code>playstation.com.*</code> نیست) را رد کنیم.</p><p>دومین مشکل این است که سرور روی همه IP های دستگاه در حال شنیدن است. به عبارت دیگر
روی 0.0.0.0 بایند شده. این یعنی هر کسی که بتواند به پورت 1235 دستگاه از خارج
دسترسی داشته باشد می‌تواند به آن وصل شود. در دنیای واقعی این مشکل آنقدر ترسناک
نیست زیرا اکثر مودم و روترها تنها اجازه دسترسی مستقیم به پورت را در شبکه داخلی
می‌دهند. <strong>برای حل این مشکل باید سرور روی localhost بایند شود.</strong></p><h2 id=چی-یاد-گرفتیم>چی یاد گرفتیم؟<a hidden class=anchor aria-hidden=true href=#چی-یاد-گرفتیم>#</a></h2><p>متاسفانه در این باگ مرزهای علم را جابجا نکردم و دانش جدیدی تولید نشد. خودم هم
چیز جدیدی یاد نگرفتم. اما امیدوارم خواننده چند نکته یادگرفته باشد. اگر بازخورد
یا پیشنهادی دارید، <a href=https://twitter.com/CryptoGangsta>پیدا کردن من در اینترنت</a> بسیار راحت
است.</p><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p>به این هدرها forbidden header می‌گویند.&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div></div><footer class=post-footer></footer></article></main><footer class=footer><span>تحت مجوز <a href=https://creativecommons.org/licenses/by-nc/4.0/>کریتیو کامنز اختیار-غیرتجاری 4.0 بین‌المللی</a></span>
<span>&#183;</span>
<span>Powered by <a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a></span>
<span>&#183;</span>
<span>Theme <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)"><button class=top-link id=top-link type=button accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></button></a>
<script defer src=/parsiya.fa/assets/js/highlight.min.e85ad0406048e8176e1c7661b25d5c69297ddfe41dc4124cf75ecb99a4f7b3d1.js integrity="sha256-6FrQQGBI6BduHHZhsl1caSl93+QdxBJM917LmaT3s9E=" onload=hljs.initHighlightingOnLoad()></script>
<script>window.onload=function(){localStorage.getItem("menu-scroll-position")&&(document.getElementById("menu").scrollLeft=localStorage.getItem("menu-scroll-position"))};function menu_on_scroll(){localStorage.setItem("menu-scroll-position",document.getElementById("menu").scrollLeft)}document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>